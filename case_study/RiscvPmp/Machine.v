(******************************************************************************)
(* Copyright (c) 2020 Steven Keuchel, Dominique Devriese, Sander Huyghebaert  *)
(* All rights reserved.                                                       *)
(*                                                                            *)
(* Redistribution and use in source and binary forms, with or without         *)
(* modification, are permitted provided that the following conditions are     *)
(* met:                                                                       *)
(*                                                                            *)
(* 1. Redistributions of source code must retain the above copyright notice,  *)
(*    this list of conditions and the following disclaimer.                   *)
(*                                                                            *)
(* 2. Redistributions in binary form must reproduce the above copyright       *)
(*    notice, this list of conditions and the following disclaimer in the     *)
(*    documentation and/or other materials provided with the distribution.    *)
(*                                                                            *)
(* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS        *)
(* "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  *)
(* TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR *)
(* PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR          *)
(* CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,      *)
(* EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,        *)
(* PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR         *)
(* PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF     *)
(* LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING       *)
(* NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS         *)
(* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.               *)
(******************************************************************************)

From Coq Require Import
     Strings.String.
From Equations Require Import
     Equations.
From MicroSail Require Import
     Syntax.
From RiscvPmp Require Export
     Values.

Set Implicit Arguments.
Import CtxNotations.
Import EnvNotations.
Open Scope string_scope.

Module RiscvPmpTermKit <: TermKit.
  Module valuekit := RiscvPmpValueKit.
  Module Export VAL := Syntax.Values.Values valuekit.

  (** Variables **)
  Definition ùëø        := string.
  Definition ùëø_eq_dec := string_dec.
  Definition ùë∫        := string.
  Definition ùë∫_eq_dec := string_dec.

  Notation PCtx := (NCtx ùëø Ty).
  Notation LCtx := (NCtx ùë∫ Ty).

  Definition ùëøtoùë∫ (x : ùëø) : ùë∫ := x.
  Definition fresh := Context.fresh (T := Ty).

  Module RiscvPmpVariableNotation.
    Notation "'rs1'" := "rs1" : string_scope.
    Notation "'rs2'" := "rs2" : string_scope.
    Notation "'rd'"  := "rd" : string_scope.
    Notation "'op'"  := "op" : string_scope.
  End RiscvPmpVariableNotation.
  Import RiscvPmpVariableNotation.

  (** Functions **)
  Inductive Fun : PCtx -> Ty -> Set :=
  | execute_RTYPE : Fun [rs2 ‚à∂ ty_regidx, rs1 ‚à∂ ty_regidx, rd ‚à∂ ty_regidx, op ‚à∂ ty_rop] ty_retired.

  Inductive FunX : PCtx -> Ty -> Set :=.

  Inductive Lem : PCtx -> Set :=. 

  Definition ùë≠  : PCtx -> Ty -> Set := Fun.
  Definition ùë≠ùëø  : PCtx -> Ty -> Set := FunX.
  Definition ùë≥  : PCtx -> Set := Lem.

  Inductive Reg : Ty -> Set :=
  | pc   : Reg ty_word
  | x1 : Reg ty_word
  | x2 : Reg ty_word.

  Section TransparentObligations.
    Local Set Transparent Obligations.
    Derive Signature NoConfusion for Reg.
  End TransparentObligations.

  Definition ùëπùë¨ùëÆ : Ty -> Set := Reg.
  Definition ùëπùë¨ùëÆ_eq_dec : EqDec (sigT Reg).
  Proof.
    intros [? []] [? []]; cbn;
      first
        [ left; now apply eq_refl
        | right; intros e; dependent elimination e
        ].
  Defined.
End RiscvPmpTermKit.

Module RiscvPmpProgramKit <: (ProgramKit RiscvPmpTermKit).
  Module Export TM := Terms RiscvPmpTermKit.

  Import RiscvPmpVariableNotation.

  (** Functions **)
  Definition fun_execute_RTYPE : Stm [rs2 ‚à∂ ty_regidx, rs1 ‚à∂ ty_regidx, rd ‚à∂ ty_regidx, op ‚à∂ ty_rop] ty_retired := stm_lit ty_retired RETIRE_SUCCESS.

  Definition RegStore := GenericRegStore.
  Definition read_register := generic_read_register.
  Definition write_register := generic_write_register.
  Definition read_write := generic_read_write.
  Definition read_write_distinct := generic_read_write_distinct.
  Definition write_read := generic_write_read.
  Definition write_write := generic_write_write.

  (* Memory *)
  Definition Memory := Addr -> Word.

  Definition ForeignCall {œÉs œÉ} (f : ùë≠ùëø œÉs œÉ) :
    forall (args : NamedEnv Lit œÉs) (res : string + Lit œÉ) (Œ≥ Œ≥' : RegStore) (Œº Œº' : Memory), Prop :=
    match f with
    end.

  Lemma ForeignProgress {œÉs œÉ} (f : ùë≠ùëø œÉs œÉ) (args : NamedEnv Lit œÉs) Œ≥ Œº :
    exists Œ≥' Œº' res, ForeignCall f args res Œ≥ Œ≥' Œº Œº'.
  Proof.
    destruct f.
  Qed.


  Definition Pi {Œî œÑ} (f : Fun Œî œÑ) : Stm Œî œÑ :=
    match f with
    | execute_RTYPE => fun_execute_RTYPE
    end.

End RiscvPmpProgramKit.
